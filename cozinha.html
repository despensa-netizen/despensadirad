<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cozinha — EstoqueSync</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    :root { --primary: #2f75b5; --bg: #f4f7f9; --card: #ffffff; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h2 { font-size: 1.1rem; color: var(--primary); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    select, input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
    button { background: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; }
    .stock-list { max-height: 300px; overflow-y: auto; font-size: 0.9rem; }
    .stock-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f1f1; }
    .badge-low { color: #ef4444; font-weight: bold; }
    .cardapio-item { background: #e0f2fe; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
  </style>
</head>
<body>

  <header>
    <h1><i class="fas fa-utensils"></i> Painel da Cozinha</h1>
    <button onclick="firebase.auth().signOut()" style="width: auto; background: #666;">Sair</button>
  </header>

  <div class="grid">
    <div class="card">
      <h2><i class="fas fa-search"></i> Itens Disponíveis no Estoque</h2>
      <div class="stock-list" id="stockList">Carregando estoque...</div>
    </div>

    <div class="card">
      <h2><i class="fas fa-calendar-day"></i> Planejamento da Nutrição</h2>
      <div id="cardapioDia">Carregando cardápio...</div>
    </div>

    <div class="card" style="grid-column: span 2;">
      <h2><i class="fas fa-paper-plane"></i> Nova Requisição ao Estoque</h2>
      <form id="formReq">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
          <select id="itemSelect" required><option value="">Selecione o produto...</option></select>
          <input type="number" id="qtdReq" placeholder="Qtd" required>
          <button type="submit">Enviar Pedido</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCw9_UbayZEcIZOu65yoOSGbHAlomxs-GE",
      authDomain: "estoquesync-f0d10.firebaseapp.com",
      projectId: "estoquesync-f0d10",
      storageBucket: "estoquesync-f0d10.appspot.com",
      messagingSenderId: "67257178512",
      appId: "1:67257178512:web:cdf3f994c0bc87c73ffb15"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. Carregar Estoque em tempo real e preencher Select
    db.collection('estoque').onSnapshot(snap => {
      const list = document.getElementById('stockList');
      const select = document.getElementById('itemSelect');
      list.innerHTML = '';
      select.innerHTML = '<option value="">Selecione o produto...</option>';

      snap.forEach(doc => {
        const d = doc.data();
        // Lista visual
        const lowStock = d.quantidade < 5 ? '<span class="badge-low"> (Baixo)</span>' : '';
        list.innerHTML += `<div class="stock-item"><span>${d.nome}</span><span>${d.quantidade} ${d.unidade || 'un'}${lowStock}</span></div>`;
        
        // Opções do formulário
        const opt = document.createElement('option');
        opt.value = d.nome;
        opt.textContent = `${d.nome} (Disponível: ${d.quantidade})`;
        select.appendChild(opt);
      });
    });

    // 2. Carregar Cardápio (Integração Nutri)
    db.collection('cardapio').where('ativo', '==', true).onSnapshot(snap => {
      const div = document.getElementById('cardapioDia');
      div.innerHTML = snap.empty ? 'Nenhum cardápio planejado para hoje.' : '';
      snap.forEach(doc => {
        const c = doc.data();
        div.innerHTML += `<div class="cardapio-item"><strong>${c.refeicao}:</strong> ${c.descricao}<br><small>Ingredientes: ${c.ingredientes}</small></div>`;
      });
    });

    // 3. Enviar Requisição
    document.getElementById('formReq').onsubmit = async (e) => {
      e.preventDefault();
      const user = firebase.auth().currentUser;
      const pedido = {
        item: document.getElementById('itemSelect').value,
        quantidade: Number(document.getElementById('qtdReq').value),
        status: 'pendente',
        usuario: user.email,
        data: firebase.firestore.FieldValue.serverTimestamp(),
        origem: 'cozinha'
      };

      try {
        await db.collection('requisicoes').add(pedido);
        alert("Requisição enviada com sucesso!");
        e.target.reset();
      } catch (err) {
        alert("Erro ao enviar: " + err.message);
      }
    };
  </script>
</body>
</html>
