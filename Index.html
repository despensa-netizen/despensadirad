<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstoqueSync - Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body{font-family:'Inter',sans-serif;background:#f0f4ff;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;}
    .card{background:white;padding:40px 30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.1);width:100%;max-width:400px;text-align:center;}
    h2{color:#2f75b5;margin-bottom:25px;}
    input{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ddd;box-sizing:border-box;}
    .btn{width:100%;padding:12px;border:none;border-radius:8px;background:#2f75b5;color:white;font-weight:600;cursor:pointer;margin-top:10px;}
    #status{margin-top:15px;font-size:14px;color:#e74c3c;font-weight:500;}
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="card">
    <i class="fas fa-boxes fa-3x" style="color:#2f75b5;margin-bottom:15px;"></i>
    <h2>EstoqueSync</h2>
    
    <div id="loginSection">
      <input type="email" id="email" placeholder="E-mail">
      <input type="password" id="password" placeholder="Senha">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>

    <div id="status"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCw9_UbayZEcIZOu65yoOSGbHAlomxs-GE",
      authDomain: "estoquesync-f0d10.firebaseapp.com",
      projectId: "estoquesync-f0d10",
      storageBucket: "estoquesync-f0d10.appspot.com",
      messagingSenderId: "67257178512",
      appId: "1:67257178512:web:cdf3f994c0bc87c73ffb15"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const MEU_EMAIL_ADMIN = "almeidaalef68@gmail.com";

    document.getElementById('btnLogin').onclick = async () => {
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pass = document.getElementById('password').value;
      const status = document.getElementById('status');
      
      status.style.color = "#2f75b5";
      status.textContent = "Autenticando...";

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, pass);
        const user = userCredential.user;
        
        status.textContent = "Verificando perfil...";
        await verificarPerfil(user);

      } catch (err) {
        status.style.color = "red";
        status.textContent = "Erro: " + err.message;
      }
    };

    async function verificarPerfil(user) {
      const status = document.getElementById('status');
      try {
        // 1. Tenta buscar pelo UID (ID oficial do Firebase)
        let doc = await db.collection('usuarios').doc(user.uid).get();
        
        // 2. Se não achar pelo UID, tenta buscar pelo E-MAIL (Cadastro feito pelo Admin)
        if (!doc.exists) {
          const emailDoc = await db.collection('usuarios').doc(user.email.toLowerCase()).get();
          
          if (emailDoc.exists) {
            status.textContent = "Configurando seu primeiro acesso...";
            const dados = emailDoc.data();
            
            // Cria o documento definitivo com o UID e apaga o temporário (e-mail)
            await db.collection('usuarios').doc(user.uid).set(dados);
            await db.collection('usuarios').doc(user.email.toLowerCase()).delete();
            
            // Recarrega o documento agora com o UID correto
            doc = await db.collection('usuarios').doc(user.uid).get();
          } else if (user.email.toLowerCase() === MEU_EMAIL_ADMIN.toLowerCase()) {
            // Garantia para o seu e-mail de admin caso o banco seja limpo
            await db.collection('usuarios').doc(user.uid).set({
              email: user.email,
              role: 'admin',
              approved: true
            });
            doc = await db.collection('usuarios').doc(user.uid).get();
          }
        }

        if (!doc.exists) {
          status.style.color = "red";
          status.textContent = "Usuário não autorizado pelo administrador.";
          auth.signOut();
          return;
        }

        const data = doc.data();
        
        // Redirecionamento baseado no cargo
        const paginas = {
          'admin': 'admin.html',
          'estoque': 'estoque.html',
          'cozinha': 'cozinha.html',
          'nutricionista': 'nutri.html'
        };

        if (paginas[data.role]) {
          window.location.href = paginas[data.role];
        } else {
          status.style.color = "red";
          status.textContent = "Cargo não reconhecido: " + data.role;
        }

      } catch (err) {
        status.style.color = "red";
        status.textContent = "Erro de banco de dados: " + err.message;
        console.error(err);
      }
    }
  </script>
</body>
</html>
