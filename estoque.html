<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estoque Central — EstoqueSync</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    :root { --primary: #1e4e79; --secondary: #2f75b5; --bg: #f4f7f9; --white: #fff; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.1rem; }
    input, select, button { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
    button { background: var(--secondary); color: white; border: none; font-weight: 600; cursor: pointer; }
    .btn-danger { background: #dc2626; }
    #reader { width: 100%; border-radius: 8px; overflow: hidden; }
    .history-item { font-size: 0.85rem; padding: 8px; border-bottom: 1px solid #eee; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
    canvas { margin-top: 10px; max-width: 100px; } /* QR Code size */
  </style>
</head>
<body>

<div class="container">
  <div class="left">
    <div class="card">
      <h2><i class="fas fa-plus-circle"></i> Entrada / Cadastro de Produto</h2>
      <form id="formEntrada">
        <input type="text" id="nomeProd" placeholder="Nome do Produto" required>
        <input type="text" id="catProd" placeholder="Categoria (ex: Secos, Frios)">
        <input type="number" id="qtdProd" placeholder="Quantidade Inicial" required>
        <input type="text" id="unidadeProd" placeholder="Unidade (kg, un, pct)">
        <button type="submit">Cadastrar e Gerar QR Code</button>
      </form>
      <div id="qrContainer" style="text-align: center; display: none;">
        <p>QR Code Gerado:</p>
        <canvas id="qrCanvas"></canvas>
        <p id="qrLink" style="font-size: 0.7rem; color: #666;"></p>
      </div>
    </div>

    <div class="card">
      <h2><i class="fas fa-qrcode"></i> Baixa via QR Code / Avulsa</h2>
      <div id="reader"></div>
      <form id="formBaixa">
        <input type="text" id="baixaItem" placeholder="ID ou Nome do Produto" required>
        <input type="number" id="baixaQtd" placeholder="Quantidade para Retirar" required>
        <select id="baixaMotivo" required>
          <option value="">Selecione o Motivo</option>
          <option value="Cozinha">Requisição Cozinha</option>
          <option value="Vencimento">Vencimento/Avaria</option>
          <option value="Ajuste">Ajuste de Inventário</option>
          <option value="Doação">Doação/Outros</option>
        </select>
        <button type="submit" class="btn-danger">Confirmar Baixa</button>
      </form>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <h2><i class="fas fa-bell"></i> Requisições Pendentes (Cozinha)</h2>
      <div id="listaRequisicoes">Carregando...</div>
    </div>

    <div class="card">
      <h2><i class="fas fa-history"></i> Histórico de Baixas</h2>
      <div id="historicoBaixas" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div class="card" style="grid-column: span 1;">
      <h2><i class="fas fa-clipboard-list"></i> Inventário de Estoque</h2>
      <table id="tabelaInventario">
        <thead><tr><th>Item</th><th>Qtd</th><th>Ação</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCw9_UbayZEcIZOu65yoOSGbHAlomxs-GE",
    authDomain: "estoquesync-f0d10.firebaseapp.com",
    projectId: "estoquesync-f0d10",
    storageBucket: "estoquesync-f0d10.appspot.com",
    messagingSenderId: "67257178512",
    appId: "1:67257178512:web:cdf3f994c0bc87c73ffb15"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- 1. GERAÇÃO DE PRODUTO E QR CODE ---
  document.getElementById('formEntrada').onsubmit = async (e) => {
    e.preventDefault();
    const nome = document.getElementById('nomeProd').value;
    const prodData = {
      nome: nome,
      categoria: document.getElementById('catProd').value,
      quantidade: Number(document.getElementById('qtdProd').value),
      unidade: document.getElementById('unidadeProd').value,
      dataCadastro: new Date()
    };

    const docRef = await db.collection('estoque').add(prodData);
    
    // Gerar QR Code com o ID do documento
    const qr = new QRious({
      element: document.getElementById('qrCanvas'),
      value: docRef.id,
      size: 150
    });
    document.getElementById('qrContainer').style.display = 'block';
    document.getElementById('qrLink').innerText = "ID: " + docRef.id;
    e.target.reset();
  };

  // --- 2. LEITOR DE QR CODE ---
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" }, 
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      document.getElementById('baixaItem').value = decodedText;
      alert("Produto Identificado!");
    }
  );

  // --- 3. PROCESSO DE BAIXA (AVULSA OU QR) ---
  document.getElementById('formBaixa').onsubmit = async (e) => {
    e.preventDefault();
    const id = document.getElementById('baixaItem').value;
    const qtdRetirar = Number(document.getElementById('baixaQtd').value);
    const motivo = document.getElementById('baixaMotivo').value;

    const docRef = db.collection('estoque').doc(id);
    const doc = await docRef.get();

    if (doc.exists) {
      const novaQtd = doc.data().quantidade - qtdRetirar;
      if (novaQtd < 0) return alert("Saldo insuficiente!");

      await docRef.update({ quantidade: novaQtd });
      
      // Registrar no histórico de baixas
      await db.collection('historico_baixas').add({
        itemNome: doc.data().nome,
        quantidade: qtdRetirar,
        motivo: motivo,
        data: new Date(),
        usuario: firebase.auth().currentUser.email
      });

      alert("Baixa realizada!");
      e.target.reset();
    } else {
      alert("Produto não encontrado. Verifique o ID.");
    }
  };

  // --- 4. CARREGAR REQUISIÇÕES DA COZINHA ---
  db.collection('requisicoes').where('status', '==', 'pendente').onSnapshot(snap => {
    const container = document.getElementById('listaRequisicoes');
    container.innerHTML = '';
    snap.forEach(doc => {
      const r = doc.data();
      container.innerHTML += `
        <div class="history-item" style="background: #fff9db; margin-bottom: 5px; border-radius: 4px;">
          <strong>${r.item}</strong> (${r.quantidade}) - Solicitado por: ${r.usuario}
          <button onclick="atenderRequisicao('${doc.id}', '${r.item}', ${r.quantidade})" style="padding: 2px 5px; font-size: 0.7rem; width: auto; margin-left: 10px;">Atender</button>
        </div>`;
    });
  });

  async function atenderRequisicao(reqId, itemNome, qtd) {
    // Busca o item no estoque pelo nome
    const estoqueSnap = await db.collection('estoque').where('nome', '==', itemNome).get();
    if (!estoqueSnap.empty) {
      const pDoc = estoqueSnap.docs[0];
      await pDoc.ref.update({ quantidade: pDoc.data().quantidade - qtd });
      await db.collection('requisicoes').doc(reqId).update({ status: 'atendido' });
      alert("Pedido da cozinha atendido e estoque atualizado!");
    }
  }

  // --- 5. HISTÓRICO E INVENTÁRIO ---
  db.collection('historico_baixas').orderBy('data', 'desc').limit(10).onSnapshot(snap => {
    const h = document.getElementById('historicoBaixas');
    h.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      h.innerHTML += `<div class="history-item"><b>${d.itemNome}</b>: -${d.quantidade} (${d.motivo})</div>`;
    });
  });

  db.collection('estoque').onSnapshot(snap => {
    const tb = document.querySelector('#tabelaInventario tbody');
    tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      tb.innerHTML += `<tr><td>${d.nome}</td><td>${d.quantidade}</td><td><small>${doc.id}</small></td></tr>`;
    });
  });

</script>
</body>
</html>
