<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstoqueSync — Versão Auditada v10.0</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    /* Estilos preservados conforme original para manter a identidade visual */
    :root { --primary: #1e3a8a; --accent: #3b82f6; --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --danger: #ef4444; --success: #22c55e; --warning: #f59e0b; --military: #334155; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    nav { background: var(--military); color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
    .container { max-width: 1400px; margin: 1rem auto; padding: 0 1rem; }
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #e2e8f0; overflow-x: auto; background: white; padding: 10px; border-radius: 8px; }
    .tab-btn { padding: 10px 15px; cursor: pointer; border: none; background: none; font-weight: bold; color: #64748b; font-size: 0.75rem; text-transform: uppercase; }
    .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
    .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .hidden { display: none !important; }
    .btn { cursor: pointer; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; font-size: 0.7rem; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px; background: #f8fafc; font-size: 0.7rem; color: #64748b; }
    td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.8rem; }
    #reader { width: 100%; max-width: 400px; margin: auto; border-radius: 8px; overflow: hidden; }
    .alerta-peps { background: #fff7ed; border: 2px solid #f97316; padding: 15px; border-radius: 10px; margin: 10px 0; color: #9a3412; font-weight: bold; }
    #qrModal, #modalBaixa { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000; }
    .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
  </style>
</head>
<body>

  <nav>
    <div style="display:flex; align-items:center; gap:10px;">
      <i class="fas fa-boxes-stacked"></i>
      <span style="font-weight:bold; letter-spacing:1px;">ESTOQUESYNC PRO</span>
    </div>
    <div style="display:flex; align-items:center; gap:15px;">
      <span id="userRoleDisplay" style="font-size:0.7rem; background:rgba(255,255,255,0.2); padding:3px 8px; border-radius:10px;"></span>
      <button id="logoutBtn" class="btn" style="background:none; color:white; border:1px solid white;">SAIR</button>
    </div>
  </nav>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(event, 'tab-saidas')">Operação</button>
      <button class="tab-btn" onclick="switchTab(event, 'tab-cadastro')">Produtos</button>
      <button class="tab-btn" onclick="switchTab(event, 'tab-entrada')">Entrada PEPS</button>
      <button class="tab-btn" onclick="switchTab(event, 'tab-historico')">Histórico</button>
    </div>

    <div id="tab-saidas" class="tab-content">
      <div style="display:grid; grid-template-columns: 1fr 2fr; gap:1.5rem;">
        <div class="card">
          <h3>Scanner de Saída</h3>
          <button class="btn btn-primary" style="width:100%; padding:15px;" onclick="toggleScanner()">LIGAR CÂMERA</button>
          <div id="reader" class="hidden" style="margin-top:10px;"></div>
        </div>
        <div class="card">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <h3>Estoque Atual</h3>
            <input type="text" id="filtro" placeholder="Filtrar..." onkeyup="filtrar()" style="padding:5px; border-radius:5px; border:1px solid #ddd;">
          </div>
          <table id="tabelaEstoque">
            <thead><tr><th>Item</th><th>Saldo</th><th>Validade</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="tab-cadastro" class="tab-content hidden">
      <div class="card">
        <h3>Novo Produto</h3>
        <form id="formCad">
          <input type="hidden" id="editId">
          <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px;">
            <input type="text" id="cadNome" placeholder="Nome" required>
            <input type="text" id="cadLocal" placeholder="Local">
            <input type="number" id="cadMin" placeholder="Mínimo">
          </div>
          <button type="submit" class="btn btn-success" style="width:100%; margin-top:10px;">SALVAR E GERAR QR</button>
        </form>
        <table style="margin-top:20px;">
            <thead><tr><th>Nome</th><th>Local</th><th>Ações</th></tr></thead>
            <tbody id="corpoCad"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-entrada" class="tab-content hidden">
        <div class="card" style="max-width:500px; margin:auto;">
            <h3>Entrada de Mercadoria (Lote)</h3>
            <form id="formPeps">
                <select id="pepsProd" required><option value="">Selecione o Produto...</option></select>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <input type="number" id="pepsQtd" step="0.01" placeholder="Quantidade" required>
                    <input type="date" id="pepsVal" required>
                </div>
                <input type="text" id="pepsLote" placeholder="Número do Lote" style="width:100%; margin-top:10px;">
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:10px; padding:12px;">REGISTRAR ENTRADA</button>
            </form>
        </div>
    </div>

    <div id="tab-historico" class="tab-content hidden">
        <div class="card">
            <h3>Movimentações Recentes</h3>
            <table id="tabelaHist">
                <thead><tr><th>Data</th><th>Tipo</th><th>Produto</th><th>Qtd</th></tr></thead>
                <tbody id="corpoHist"></tbody>
            </table>
        </div>
    </div>
  </div>

  <div id="qrModal" class="hidden">
    <div class="modal-box">
      <h3 id="qrTitle"></h3>
      <canvas id="qrCanvas"></canvas><br>
      <button onclick="window.print()" class="btn btn-primary">IMPRIMIR</button>
      <button onclick="document.getElementById('qrModal').classList.add('hidden')" class="btn">FECHAR</button>
    </div>
  </div>

  <div id="modalBaixa" class="hidden">
    <div class="modal-box">
        <h2 id="bxNome"></h2>
        <div id="bxAviso" class="alerta-peps"></div>
        <input type="number" id="bxQtd" step="0.01" placeholder="Qtd Baixa" style="font-size:2rem; width:100%; text-align:center; margin-bottom:15px;">
        <input type="hidden" id="bxId">
        <div style="display:flex; gap:10px;">
            <button onclick="executarBaixa()" class="btn btn-success" style="flex:1; padding:12px;">CONFIRMAR</button>
            <button onclick="document.getElementById('modalBaixa').classList.add('hidden')" class="btn btn-danger" style="flex:1;">CANCELAR</button>
        </div>
    </div>
  </div>

  <script>
    // Configuração do Firebase (Atenção: Use as suas chaves aqui)
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SUA_AUTH_DOMAIN",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_STORAGE_BUCKET",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let html5QrCode;

    // --- SEGURANÇA E AUTH ---
    auth.onAuthStateChanged(user => {
        if(!user) return; // Redirecionar se necessário
        document.getElementById('userRoleDisplay').innerText = user.email.split('@')[0].toUpperCase();
        carregarDados();
        carregarHist();
    });

    // --- CARREGAMENTO DE DADOS (OTIMIZADO) ---
    function carregarDados() {
        db.collection('estoque').orderBy('nome').onSnapshot(snap => {
            const tb = document.querySelector('#tabelaEstoque tbody');
            const cp = document.getElementById('corpoCad');
            const sel = document.getElementById('pepsProd');
            tb.innerHTML = ''; cp.innerHTML = ''; sel.innerHTML = '<option value="">Selecione...</option>';

            snap.forEach(doc => {
                const p = doc.data();
                const id = doc.id;
                
                // Tabela de Operação
                tb.innerHTML += `<tr>
                    <td>${p.nome}</td>
                    <td><b>${p.quantidade.toFixed(2)}</b></td>
                    <td>${p.validade || '--'}</td>
                    <td><button class="btn btn-primary" onclick="abrirBaixa('${id}')"><i class="fas fa-minus"></i></button></td>
                </tr>`;

                // Tabela de Gestão
                cp.innerHTML += `<tr>
                    <td>${p.nome}</td>
                    <td>${p.local || '-'}</td>
                    <td>
                        <button class="btn btn-primary" onclick="gerarQR('${id}', '${p.nome}')"><i class="fas fa-qrcode"></i></button>
                    </td>
                </tr>`;

                sel.innerHTML += `<option value="${id}">${p.nome}</option>`;
            });
        });
    }

    // --- ENTRADA PEPS (COM AUDITORIA) ---
    document.getElementById('formPeps').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('pepsProd').value;
        const q = parseFloat(document.getElementById('pepsQtd').value);
        const v = document.getElementById('pepsVal').value;
        const l = document.getElementById('pepsLote').value || 'S/L';

        try {
            const batch = db.batch();
            const prodRef = db.collection('estoque').doc(id);
            const pDoc = await prodRef.get();

            // Adicionar Lote
            const loteRef = db.collection('lotes').doc();
            batch.set(loteRef, { idProduto: id, quantidade: q, validade: v, lote: l, data: new Date() });

            // Atualizar Produto Principal (Uso de Increment para segurança)
            let updateData = { quantidade: firebase.firestore.FieldValue.increment(q) };
            if (pDoc.data().validade === '--' || v < pDoc.data().validade) {
                updateData.validade = v;
            }
            batch.update(prodRef, updateData);

            // Log de História
            const logRef = db.collection('historico').doc();
            batch.set(logRef, { data: new Date(), tipo: 'ENTRADA', produto: pDoc.data().nome, quantidade: q });

            await batch.commit();
            alert("Entrada registrada!");
            e.target.reset();
        } catch (err) { alert("Erro: " + err.message); }
    };

    // --- BAIXA PEPS (O CORAÇÃO DA AUDITORIA) ---
    async function abrirBaixa(id) {
        const doc = await db.collection('estoque').doc(id).get();
        if(!doc.exists) return alert("Erro: Produto não encontrado!");
        
        const p = doc.data();
        document.getElementById('bxId').value = id;
        document.getElementById('bxNome').innerText = p.nome;

        // Buscar lote sugerido (Mais antigo primeiro)
        const loteSnap = await db.collection('lotes')
            .where('idProduto', '==', id)
            .where('quantidade', '>', 0)
            .orderBy('validade', 'asc')
            .limit(1).get();

        const aviso = document.getElementById('bxAviso');
        if(!loteSnap.empty) {
            const ld = loteSnap.docs[0].data();
            aviso.innerHTML = `SUGESTÃO PEPS:<br>Lote: ${ld.lote} | Validade: ${ld.validade}`;
        } else {
            aviso.innerText = "Atenção: Nenhum lote com validade encontrado.";
        }
        document.getElementById('modalBaixa').classList.remove('hidden');
    }

    async function executarBaixa() {
        const id = document.getElementById('bxId').value;
        const qBaixar = parseFloat(document.getElementById('bxQtd').value);
        if(!qBaixar || qBaixar <= 0) return;

        try {
            const prodRef = db.collection('estoque').doc(id);
            const pDoc = await prodRef.get();
            if(pDoc.data().quantidade < qBaixar) return alert("Saldo insuficiente!");

            // Lógica de Abatimento nos Lotes
            let restante = qBaixar;
            const lotesSnap = await db.collection('lotes')
                .where('idProduto', '==', id)
                .where('quantidade', '>', 0)
                .orderBy('validade', 'asc').get();

            const batch = db.batch();
            lotesSnap.forEach(lDoc => {
                if(restante <= 0) return;
                const lq = lDoc.data().quantidade;
                if(lq >= restante) {
                    batch.update(lDoc.ref, { quantidade: lq - restante });
                    restante = 0;
                } else {
                    batch.update(lDoc.ref, { quantidade: 0 });
                    restante -= lq;
                }
            });

            // Atualizar Saldo Principal (Decremento Seguro)
            batch.update(prodRef, { quantidade: firebase.firestore.FieldValue.increment(-qBaixar) });
            
            // Log
            const logRef = db.collection('historico').doc();
            batch.set(logRef, { data: new Date(), tipo: 'SAÍDA', produto: pDoc.data().nome, quantidade: qBaixar });

            await batch.commit();
            document.getElementById('modalBaixa').classList.add('hidden');
            alert("Baixa confirmada!");
        } catch(e) { alert("Erro na baixa: " + e.message); }
    }

    // --- FUNÇÕES DE INTERFACE ---
    function switchTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        e.currentTarget.classList.add('active');
    }

    function toggleScanner() {
        const r = document.getElementById('reader');
        if(r.classList.contains('hidden')) {
            r.classList.remove('hidden');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (id) => {
                html5QrCode.stop(); r.classList.add('hidden'); abrirBaixa(id);
            });
        } else {
            html5QrCode.stop(); r.classList.add('hidden');
        }
    }

    function gerarQR(id, nome) {
        document.getElementById('qrModal').classList.remove('hidden');
        document.getElementById('qrTitle').innerText = nome;
        new QRious({ element: document.getElementById('qrCanvas'), value: id, size: 200 });
    }

    function carregarHist() {
        db.collection('historico').orderBy('data', 'desc').limit(20).onSnapshot(snap => {
            const h = document.getElementById('corpoHist'); h.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                h.innerHTML += `<tr><td>${d.data.toDate().toLocaleDateString()}</td><td>${d.tipo}</td><td>${d.produto}</td><td>${d.quantidade}</td></tr>`;
            });
        });
    }

    document.getElementById('logoutBtn').onclick = () => auth.signOut();
  </script>
</body>
</html><table id="tabelaCatalogo">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Categoria</th>
      <th>Mín.</th>
      <th>Local</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody id="corpoCatalogo">
    </tbody>
</table>

<script>
// --- FUNÇÃO DE RENDERIZAÇÃO ATUALIZADA ---
function renderEstoque() {
  db.collection('estoque').orderBy('nome').onSnapshot(snap => {
    const tb = document.querySelector('#tabelaEstoque tbody');
    const cat = document.getElementById('corpoCatalogo');
    const sRec = document.getElementById('recProdSelect');
    
    tb.innerHTML = ''; cat.innerHTML = ''; 
    sRec.innerHTML = '<option value="">Selecione...</option>';

    snap.forEach(doc => {
      const p = doc.data();
      const id = doc.id;

      // Tabela de Cargas & Saídas
      tb.innerHTML += `
        <tr>
            <td>${p.nome}</td>
            <td><b>${p.quantidade.toFixed(2)}</b> ${p.unidade}</td>
            <td>${p.local || '-'}</td>
            <td>${p.validade || '--'}</td>
            <td>
                <button class="btn btn-primary" onclick="abrirModalBaixa('${id}')"><i class="fas fa-minus"></i></button>
                <button class="btn" style="background:#64748b; color:white;" onclick="verLotes('${id}','${p.nome}')"><i class="fas fa-layer-group"></i></button>
            </td>
        </tr>`;

      // Tabela de Gestão (RESTAURADO BOTÃO QR CODE)
      cat.innerHTML += `
        <tr>
            <td>${p.nome}</td>
            <td>${p.categoria}</td>
            <td>${p.estoqueMinimo}</td>
            <td>${p.local || '-'}</td>
            <td>
                <button class="btn btn-warning" onclick="prepararEdicao('${id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-primary" onclick="gerarQR('${id}','${p.nome}')"><i class="fas fa-qrcode"></i></button>
            </td>
        </tr>`;

      sRec.innerHTML += `<option value="${id}|${p.nome}">${p.nome}</option>`;
    });
  });
}

// --- SALVAR PRODUTO E GERAR QR AUTOMÁTICO ---
document.getElementById('formCadastro').onsubmit = async (e) => {
    e.preventDefault();
    const idExistente = document.getElementById('editId').value;
    const nome = document.getElementById('cadNome').value;
    
    const dados = {
        nome: nome,
        categoria: document.getElementById('cadCat').value,
        unidade: document.getElementById('cadUn').value,
        local: document.getElementById('cadLocal').value,
        estoqueMinimo: parseFloat(document.getElementById('cadMin').value) || 0
    };

    try {
        if (idExistente) {
            await db.collection('estoque').doc(idExistente).update(dados);
            alert("Produto atualizado!");
        } else {
            dados.quantidade = 0;
            dados.validade = '--';
            const novoDoc = await db.collection('estoque').add(dados);
            alert("Produto cadastrado! Gerando QR Code...");
            gerarQR(novoDoc.id, nome); // GERAR QR AUTOMÁTICO AO CADASTRAR NOVO
        }
        resetFormCadastro();
    } catch (err) {
        alert("Erro ao salvar: " + err.message);
    }
};

// --- FUNÇÃO PARA GERAR/EXIBIR QR CODE ---
function gerarQR(id, nome) {
    document.getElementById('qrTitle').innerText = nome;
    document.getElementById('qrModal').classList.remove('hidden');
    const qr = new QRious({
        element: document.getElementById('qrCanvas'),
        value: id,
        size: 200
    });
}

// --- HISTÓRICO RESTAURADO (SEM FILTRO QUE APAGA DADOS) ---
function carregarHistorico() {
    // Removido o filtro de 30 dias para garantir que dados antigos apareçam
    db.collection('historico').orderBy('data', 'desc').limit(50).onSnapshot(snap => {
        const tb = document.getElementById('corpoHist');
        tb.innerHTML = '';
        snap.forEach(doc => {
            const h = doc.data();
            const dataFormatada = h.data ? h.data.toDate().toLocaleString() : '--';
            tb.innerHTML += `
                <tr>
                    <td>${dataFormatada}</td>
                    <td>${h.tipo}</td>
                    <td>${h.produto}</td>
                    <td>${h.quantidade}</td>
                    <td>${h.user || 'Sistema'}</td>
                </tr>`;
        });
    });
}
</script>
