<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EstoqueSync — Programação de Rancho</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root {
      --military: #1e293b; --accent: #2563eb; --bg: #f1f5f9; --card: #ffffff;
      --cafe: #f59e0b; --almoco: #10b981; --janta: #6366f1;
    }

    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #1e293b; }
    nav { background: var(--military); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
    
    .container { max-width: 1600px; margin: 1.5rem auto; padding: 0 1rem; }
    
    /* Grade Semanal */
    .semana-grid { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: 15px; 
      margin-top: 20px;
      overflow-x: auto;
    }

    .dia-col { background: #e2e8f0; border-radius: 12px; padding: 10px; min-width: 200px; border: 1px solid #cbd5e1; }
    .dia-header { text-align: center; font-weight: 700; padding-bottom: 10px; color: var(--military); border-bottom: 2px solid #cbd5e1; margin-bottom: 10px; }

    .slot { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #ccc; }
    .slot-cafe { border-left-color: var(--cafe); }
    .slot-almoco { border-left-color: var(--almoco); }
    .slot-janta { border-left-color: var(--janta); }
    
    .slot-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: block; }
    .slot-label.cafe { color: var(--cafe); }
    .slot-label.almoco { color: var(--almoco); }
    .slot-label.janta { color: var(--janta); }

    select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ddd; font-size: 0.85rem; }

    .card { background: var(--card); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
    .btn-save { background: var(--accent); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 20px; font-size: 1rem; }
    
    .floating-actions { position: sticky; bottom: 20px; width: 100%; display: flex; justify-content: center; }

    .btn-toggle { background: #fff; border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-bottom: 20px; font-weight: 600; }
    .btn-toggle.active { background: var(--accent); color: white; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <nav>
    <div style="display:flex; align-items:center; gap:10px;">
      <i class="fas fa-shield-halved fa-lg"></i>
      <h2 style="margin:0; font-size: 1.2rem;">Rancho Militar <span style="font-weight:300;">EstoqueSync</span></h2>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
      <button class="btn-toggle" onclick="toggleView('config')">Cadastrar Receitas</button>
      <button class="btn-toggle active" onclick="toggleView('agenda')">Programação Semanal</button>
      <button onclick="firebase.auth().signOut()" style="background:none; border:1px solid white; color:white; padding:5px 15px; border-radius:6px; cursor:pointer;">SAIR</button>
    </div>
  </nav>

  <div class="container">
    
    <div id="view-config" class="hidden">
        <div class="card">
            <h3><i class="fas fa-plus-circle"></i> Cadastrar Nova Carga (Receita Padrão)</h3>
            <p style="font-size: 0.85rem; color: #64748b;">Cadastre aqui os pratos fixos. Ex: "Arroz de Carreteiro", "Café Padrão", "Sopa de Legumes".</p>
            <form id="formNovaReceita">
                <input type="text" id="recNome" placeholder="Nome da Carga (ex: Almoço Tipo A)" required>
                <div id="ingredientesLista">
                    <label>Itens da Despensa para esta Carga:</label>
                    </div>
                <button type="button" onclick="addIngredienteCampo()" style="margin: 10px 0; padding: 5px; cursor:pointer;">+ Adicionar Item</button>
                <button type="submit" class="btn-save" style="background: var(--almoco);">Salvar Receita no Banco</button>
            </form>
        </div>
    </div>

    <div id="view-agenda">
        <div class="card">
            <h3><i class="fas fa-calendar-alt"></i> Planejamento do Rancho (QTS)</h3>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                <label>Data de Início (Segunda-feira):</label>
                <input type="date" id="dataInicioSemana" style="width:auto; padding:5px;">
            </div>

            <div class="semana-grid" id="semanaGrid">
                </div>

            <button class="btn-save" onclick="salvarProgramacaoSemanal()">
                <i class="fas fa-cloud-upload-alt"></i> PUBLICAR SEMANA E GERAR REQUISIÇÕES
            </button>
        </div>
    </div>

  </div>

  <script>
    // CONFIGURAÇÃO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCw9_UbayZEcIZOu65yoOSGbHAlomxs-GE",
      authDomain: "estoquesync-f0d10.firebaseapp.com",
      projectId: "estoquesync-f0d10",
      storageBucket: "estoquesync-f0d10.appspot.com",
      messagingSenderId: "67257178512",
      appId: "1:67257178512:web:cdf3f994c0bc87c73ffb15"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let estoqueItens = [];
    let receitasSalvas = [];
    const diasSemana = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"];

    // INICIALIZAÇÃO
    firebase.auth().onAuthStateChanged(user => {
      if (!user) window.location.href = 'index.html';
      carregarDadosBase();
    });

    async function carregarDadosBase() {
        // Carrega Itens do Estoque
        db.collection('estoque').orderBy('nome').onSnapshot(snap => {
            estoqueItens = [];
            snap.forEach(doc => estoqueItens.push(doc.data().nome));
        });

        // Carrega Receitas (Cargas)
        db.collection('receitas').orderBy('nome').onSnapshot(snap => {
            receitasSalvas = [];
            snap.forEach(doc => {
                receitasSalvas.push({ id: doc.id, ...doc.data() });
            });
            montarGradeSemanal();
        });
    }

    function toggleView(view) {
        document.getElementById('view-config').classList.toggle('hidden', view !== 'config');
        document.getElementById('view-agenda').classList.toggle('hidden', view !== 'agenda');
        document.querySelectorAll('.btn-toggle').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(view)));
    }

    // MONTAGEM DA GRADE DE PROGRAMAÇÃO
    function montarGradeSemanal() {
        const grid = document.getElementById('semanaGrid');
        grid.innerHTML = '';

        diasSemana.forEach((dia, index) => {
            const col = document.createElement('div');
            col.className = 'dia-col';
            col.innerHTML = `
                <div class="dia-header">${dia}</div>
                
                <div class="slot slot-cafe">
                    <span class="slot-label cafe">Café da Manhã</span>
                    <select class="sel-refeicao" data-dia="${dia}" data-turno="Cafe">
                        <option value="">-- Vazio --</option>
                        ${receitasSalvas.map(r => `<option value="${r.id}">${r.nome}</option>`).join('')}
                    </select>
                </div>

                <div class="slot slot-almoco">
                    <span class="slot-label almoco">Almoço</span>
                    <select class="sel-refeicao" data-dia="${dia}" data-turno="Almoco">
                        <option value="">-- Vazio --</option>
                        ${receitasSalvas.map(r => `<option value="${r.id}">${r.nome}</option>`).join('')}
                    </select>
                </div>

                <div class="slot slot-janta">
                    <span class="slot-label janta">Jantar</span>
                    <select class="sel-refeicao" data-dia="${dia}" data-turno="Janta">
                        <option value="">-- Vazio --</option>
                        ${receitasSalvas.map(r => `<option value="${r.id}">${r.nome}</option>`).join('')}
                    </select>
                </div>
            `;
            grid.appendChild(col);
        });
    }

    // SALVAR PROGRAMAÇÃO E GERAR REQUISIÇÕES AUTOMÁTICAS
    async function salvarProgramacaoSemanal() {
        const dataInicio = document.getElementById('dataInicioSemana').value;
        if(!dataInicio) return alert("Selecione a data de início da semana!");

        if(!confirm("Isso enviará todas as requisições de materiais para a Despensa. Confirmar?")) return;

        const selects = document.querySelectorAll('.sel-refeicao');
        const batch = db.batch();

        selects.forEach(sel => {
            const receitaId = sel.value;
            if(receitaId) {
                const receita = receitasSalvas.find(r => r.id === receitaId);
                const dia = sel.dataset.dia;
                const turno = sel.dataset.turno;

                // Para cada ingrediente da receita, cria uma requisição
                receita.ingredientes.forEach(ing => {
                    const reqRef = db.collection('requisicoes').doc();
                    batch.set(reqRef, {
                        item: ing.nome,
                        quantidade: parseFloat(ing.qtd),
                        status: 'pendente',
                        dataUso: dataInicio, // Idealmente calcular a data exata do dia da semana
                        detalhe: `${dia} - ${turno} (${receita.nome})`,
                        solicitante: "Nutrição (Automático)",
                        dataSolicitacao: new Date()
                    });
                });
            }
        });

        await batch.commit();
        alert("Programação Salva! A Despensa já recebeu a lista de materiais.");
    }

    // FUNÇÕES DE CADASTRO DE RECEITA (CARGA)
    function addIngredienteCampo() {
        const div = document.createElement('div');
        div.style.display = "flex";
        div.style.gap = "5px";
        div.style.marginBottom = "5px";
        div.innerHTML = `
            <select class="ing-item" required>${estoqueItens.map(i => `<option value="${i}">${i}</option>`).join('')}</select>
            <input type="number" step="0.01" class="ing-qtd" placeholder="Qtd" style="width:80px" required>
            <button type="button" onclick="this.parentElement.remove()" style="color:red">X</button>
        `;
        document.getElementById('ingredientesLista').appendChild(div);
    }

    document.getElementById('formNovaReceita').onsubmit = async (e) => {
        e.preventDefault();
        const ings = [];
        document.querySelectorAll('#ingredientesLista div').forEach(div => {
            ings.push({
                nome: div.querySelector('.ing-item').value,
                qtd: div.querySelector('.ing-qtd').value
            });
        });

        await db.collection('receitas').add({
            nome: document.getElementById('recNome').value,
            ingredientes: ings,
            dataCriacao: new Date()
        });

        alert("Carga de Rancho salva!");
        e.target.reset();
        document.getElementById('ingredientesLista').innerHTML = '';
    };

  </script>
</body>
</html>
