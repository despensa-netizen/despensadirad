<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Nutricionista — EstoqueSync</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    :root { --primary: #2f75b5; --bg: #f8fbff; --card: #ffffff; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; }
    header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .hidden { display: none; }
    .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-add { background: #2ecc71; margin-bottom: 10px; }
    input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    .ingrediente-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .badge { background: #eee; padding: 5px 10px; border-radius: 20px; font-size: 12px; margin-right: 5px; }
  </style>
</head>
<body>
  <header>
    <h2><i class="fas fa-apple-whole"></i> Planejamento Nutricional</h2>
    <button onclick="auth.signOut()" class="btn" style="background:rgba(0,0,0,0.2)">Sair</button>
  </header>

  <div class="container hidden" id="mainContent">
    <div class="card">
      <h3><i class="fas fa-calendar-alt"></i> Definir Cardápio do Dia</h3>
      <label>Dia da Semana:</label>
      <select id="menuDay">
        <option value="Segunda">Segunda-feira</option>
        <option value="Terça">Terça-feira</option>
        <option value="Quarta">Quarta-feira</option>
        <option value="Quinta">Quinta-feira</option>
        <option value="Sexta">Sexta-feira</option>
      </select>

      <label>Nome do Prato Principial:</label>
      <input type="text" id="recipeName" placeholder="Ex: Strogonoff de Frango">

      <hr style="border: 0.5px solid #eee; margin: 20px 0;">
      
      <h4><i class="fas fa-utensils"></i> Itens Necessários (Matéria-Prima)</h4>
      <p style="font-size: 12px; color: #666;">Selecione os itens que a cozinha precisará pedir ao estoque para este prato.</p>
      
      <div id="ingredientesLista">
        <div class="ingrediente-row">
          <select class="ing-nome" id="selectEstoquePadrao"><option>Carregando itens do estoque...</option></select>
          <input type="number" class="ing-qtd" placeholder="Qtd Total" style="width: 120px;">
          <button class="btn btn-add" onclick="adicionarLinha()" title="Adicionar item"><i class="fas fa-plus"></i></button>
        </div>
      </div>

      <button class="btn" onclick="salvarCardapioCompleto()" style="width: 100%; margin-top: 20px;">
        <i class="fas fa-paper-plane"></i> Publicar Cardápio para Cozinha
      </button>
    </div>
  </div>

  <script>
    const firebaseConfig = { /* Suas Configurações do Firebase aqui */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Proteção de Rota
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      const doc = await db.collection('usuarios').doc(user.uid).get();
      if (!doc.exists || (doc.data().role !== 'nutricionista' && doc.data().role !== 'admin')) {
        alert("Acesso restrito.");
        auth.signOut();
        return;
      }
      document.getElementById('mainContent').classList.remove('hidden');
      carregarOpcoesEstoque();
    });

    // Carrega itens existentes no estoque para a Nutricionista escolher
    async function carregarOpcoesEstoque() {
      const snap = await db.collection('estoque').orderBy('nome').get();
      const selects = document.querySelectorAll('.ing-nome');
      let options = '<option value="">Selecione o produto...</option>';
      snap.forEach(doc => {
        options += `<option value="${doc.data().nome}">${doc.data().nome}</option>`;
      });
      selects.forEach(s => s.innerHTML = options);
    }

    function adicionarLinha() {
      const container = document.getElementById('ingredientesLista');
      const novaLinha = container.firstElementChild.cloneNode(true);
      novaLinha.querySelector('.ing-qtd').value = '';
      container.appendChild(novaLinha);
    }

    async function salvarCardapioCompleto() {
      const dia = document.getElementById('menuDay').value;
      const prato = document.getElementById('recipeName').value;
      
      if(!prato) { alert("Informe o nome do prato."); return; }

      const rows = document.querySelectorAll('.ingrediente-row');
      const itens = [];
      
      rows.forEach(row => {
        const nome = row.querySelector('.ing-nome').value;
        const qtd = row.querySelector('.ing-qtd').value;
        if(nome && qtd) itens.push({ nome, qtd: parseFloat(qtd) });
      });

      try {
        await db.collection('cardapio_planejado').doc(dia).set({
          dia,
          prato,
          itens,
          dataAtualizacao: new Date(),
          autor: auth.currentUser.email
        });
        alert("Cardápio de " + dia + " enviado para a cozinha!");
      } catch (e) { alert("Erro: " + e.message); }
    }
  </script>
</body>
</html>
